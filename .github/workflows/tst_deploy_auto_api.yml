on:
  schedule:
    - cron: '0 6 * * *'   # 07:00 hora Espa√±a (06:00 UTC)
    - cron: '0 18 * * *'  # 19:00 hora Espa√±a (18:00 UTC)
  workflow_dispatch:

jobs:
  despliegue:
    runs-on: ubuntu-latest

    steps:
      # 1Ô∏è‚É£ Clonar el repositorio
      - name: üß© Clonar repositorio
        uses: actions/checkout@v4

      # 2Ô∏è‚É£ Configurar Node.js
      - name: üß∞ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      # 3Ô∏è‚É£ Preparar el paquete de despliegue
      - name: üìÅ Preparar carpeta de despliegue
        run: |
          mkdir -p deploy
          rsync -av --delete \
                    --exclude='.git' \
                    --exclude='.github' \
                    --exclude='node_modules' \
                    --exclude='.env*' \
                    --exclude='*.log' \
                    ./ ./deploy/

      # 4Ô∏è‚É£ Subir archivos v√≠a SCP
      - name: üöÄ Subir archivos a AlwaysData por SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_TST }}
          username: ${{ secrets.SSH_USER_TST }}
          key: ${{ secrets.SSH_KEY_TST }}
          source: "deploy/*"
          target: "/home/tstsite/www/api"
          overwrite: true
          strip_components: 1

      # 5Ô∏è‚É£ Limpiar, instalar dependencias y reiniciar servicio
      - name: üîÅ Limpiar, instalar y reiniciar servicio en AlwaysData
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST_TST }}
          username: ${{ secrets.SSH_USER_TST }}
          key: ${{ secrets.SSH_KEY_TST }}
          fail_on_error: false
          script: |
            cd /home/tstsite/www/api

            echo "üßπ Limpiando instalaci√≥n anterior..."
            rm -rf node_modules package-lock.json
            npm cache clean --force   # Limpiar cache antes de instalar

            echo "üì¶ Instalando dependencias de producci√≥n..."
            npm install --omit=dev --no-audit --no-fund --silent

            echo "üßπ Limpiando cache despu√©s de instalar..."
            npm cache clean --force   # Limpiar cache despu√©s de instalar

            echo "‚ö° Optimizando permisos y entorno..."
            chmod -R 755 .
            export NODE_ENV=production

            echo "‚ôªÔ∏è Reiniciando servicio sin generar logs..."
            nohup node bin/www >/dev/null 2>&1 &
            disown

            if pgrep -fl "node.*bin/www" > /dev/null; then
              echo "‚úÖ Node est√° corriendo correctamente"
            else
              echo "‚ö†Ô∏è Node no se est√° ejecutando"
            fi

            echo "‚úÖ API desplegada y servicio reiniciado correctamente."

      # 6Ô∏è‚É£ Limpiar carpeta deploy local
      - name: üóëÔ∏è Eliminar carpeta de despliegue local
        run: |
          cd $GITHUB_WORKSPACE
          rm -rf deploy
          echo "‚úÖ Carpeta deploy eliminada correctamente"

      # 7Ô∏è‚É£ Limpiar carpeta deploy en el servidor remoto
      - name: üßπ Eliminar carpeta deploy remota
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST_TST }}
          username: ${{ secrets.SSH_USER_TST }}
          key: ${{ secrets.SSH_KEY_TST }}
          script: |
            if [ -d "/home/tstsite/www/api/deploy" ]; then
              rm -rf /home/tstsite/www/api/deploy
              echo "‚úÖ Carpeta deploy remota eliminada correctamente"
            else
              echo "‚ÑπÔ∏è Carpeta deploy remota no existe, nada que eliminar"
            fi
