name: ğŸŒ TST - Despliegue automÃ¡tico de API (AlwaysData)

on:
  schedule:
    - cron: '0 6 * * *'    # 07:00 hora EspaÃ±a (06:00 UTC)
    - cron: '0 18 * * *'   # 19:00 hora EspaÃ±a (18:00 UTC)
  workflow_dispatch:

jobs:
  despliegue:
    name: ğŸ” Desplegar API en AlwaysData
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Clonar repositorio
        uses: actions/checkout@v4

      - name: ğŸ§° Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '24'

      - name: ğŸ“ Preparar carpeta de despliegue
        run: |
          mkdir -p deploy
          rsync -av --delete \
            --exclude='.git' \
            --exclude='.github' \
            --exclude='node_modules' \
            --exclude='.env*' \
            --exclude='*.log' \
            --exclude='deploy' \
            ./ ./deploy/

      - name: ğŸš€ Subir archivos a AlwaysData
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_TST }}
          username: ${{ secrets.SSH_USER_TST }}
          key: ${{ secrets.SSH_KEY_TST }}
          source: "deploy/*"
          target: "/home/tstsite/www/api"
          overwrite: true
          strip_components: 1

      - name: ğŸ” Instalar dependencias y reiniciar API
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST_TST }}
          username: ${{ secrets.SSH_USER_TST }}
          key: ${{ secrets.SSH_KEY_TST }}
          script_stop: false
          script: |
            set +e
            cd /home/tstsite/www/api

            echo "ğŸ§¹ Limpiando restos anteriores..."
            rm -rf ./deploy node_modules package-lock.json

            echo "ğŸ“¦ Instalando dependencias de producciÃ³n..."
            npm ci --omit=dev --no-audit --no-fund --silent 2>/dev/null || \
            npm install --omit=dev --no-audit --no-fund --silent 2>/dev/null

            echo "âš™ï¸ Ajustando permisos..."
            chmod -R 755 .

            echo "â™»ï¸ Reiniciando servicio Node..."
            pkill -f "node.*bin/www" >/dev/null 2>&1 || true
            sleep 2
            nohup bash -c "NODE_ENV=production node bin/www >/dev/null 2>&1 &" >/dev/null 2>&1 &
            sleep 3

            if pgrep -fl "node.*bin/www" >/dev/null; then
              echo "âœ… Node corriendo correctamente"
            else
              echo "âš ï¸ Node no se estÃ¡ ejecutando"
            fi

            echo "âœ… Despliegue completado correctamente."
            exit 0

      - name: ğŸ—‘ï¸ Limpiar carpeta local
        run: rm -rf deploy
