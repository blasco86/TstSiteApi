name: TST - Despliegue automÃ¡tico de API planificado

on:
  schedule:
    - cron: "0 6,18 * * *"  # 07:00 y 19:00 hora de Madrid (UTC+1)
  workflow_dispatch:
  push:
    branches:
      - tst  # Solo cuando hay commits en la rama tst

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # 1ï¸âƒ£ Clonar repositorio
      - name: ðŸ§© Checkout repo
        uses: actions/checkout@v4

      # 2ï¸âƒ£ Configurar Node.js
      - name: ðŸ§° Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 3ï¸âƒ£ Preparar paquete de despliegue
      - name: ðŸ“ Prepare deployment package
        run: |
          mkdir deploy
          rsync -av --delete \
                    --exclude='.git' \
                    --exclude='.github' \
                    --exclude='node_modules' \
                    --exclude='.env' \
                    --exclude='.env.key' \
                    --exclude='*.log' \
                    ./ ./deploy/

      # 4ï¸âƒ£ Subir archivos vÃ­a SCP
      - name: ðŸš€ Deploy to AlwaysData via SSH
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST_TST }}       # ej: ssh-tstsite.alwaysdata.net
          username: ${{ secrets.SSH_USER_TST }}   # ej: tstsite
          key: ${{ secrets.SSH_KEY_TST }}         # clave privada SSH sin passphrase
          source: "deploy/*"
          target: "/home/tstsite/www/api"
          overwrite: true
          strip_components: 1

      # 5ï¸âƒ£ Limpieza, instalaciÃ³n e inicio del servicio
      - name: ðŸ” Clean, Install & Restart AlwaysData service
        uses: appleboy/ssh-action@v1.2.2
        with:
          host: ${{ secrets.SSH_HOST_TST }}
          username: ${{ secrets.SSH_USER_TST }}
          key: ${{ secrets.SSH_KEY_TST }}
          script: |
            cd /home/tstsite/www/api

            echo "ðŸ§¹ Limpiando instalaciÃ³n anterior..."
            rm -rf node_modules package-lock.json
            npm cache clean --force

            echo "ðŸ“¦ Instalando dependencias de producciÃ³n..."
            npm install --omit=dev --no-audit --no-fund --silent

            echo "âš¡ Optimizando permisos y entorno..."
            chmod -R 755 .
            export NODE_ENV=production

            echo "â™»ï¸ Reiniciando servicio..."
            pkill -f "node.*bin/www" || true
            nohup node bin/www > app.log 2>&1 &

            echo "âœ… API desplegada, cache limpia y servicio reiniciado correctamente."
